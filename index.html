<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Global Messenger</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --primary: #5865F2; --red: #da373c; --green: #23a559; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; outline: none; }
        body { background: var(--bg); color: white; margin: 0; height: 100vh; display: flex; overflow: hidden; }

        /* –õ–û–ì–ò–ù */
        #login { position: fixed; inset: 0; background: var(--bg); z-index: 99; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .card { background: var(--panel); padding: 30px; border-radius: 12px; width: 320px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        input, select { width: 100%; padding: 12px; background: #2b2b2b; border: 1px solid #444; color: white; border-radius: 6px; margin: 10px 0; }
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; }
        
        /* –û–°–ù–û–í–ù–û–ï –û–ö–ù–û */
        #app { display: none; width: 100%; height: 100%; flex-direction: column; }
        
        /* –°–µ—Ç–∫–∞ –≤–∏–¥–µ–æ (–∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è) */
        #video-grid { flex: 1; background: black; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; padding: 10px; overflow: auto; }
        .vid-wrap { position: relative; width: 45%; max-width: 600px; aspect-ratio: 16/9; background: #222; border-radius: 8px; overflow: hidden; border: 1px solid #444; }
        .vid-wrap video { width: 100%; height: 100%; object-fit: cover; }
        /* –ï—Å–ª–∏ –≤–∏–¥–µ–æ –≤—ã–∫–ª—é—á–µ–Ω–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ–Ω */
        .vid-wrap video.hidden { opacity: 0; }
        .vid-placeholder { position: absolute; inset:0; display: flex; align-items: center; justify-content: center; font-size: 40px; color: #555; z-index: 0; }
        .name { position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 4px; font-size: 12px; z-index: 2; }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .controls { padding: 15px; background: var(--panel); display: flex; justify-content: center; gap: 20px; }
        .btn-circle { width: 50px; height: 50px; border-radius: 50%; border: none; font-size: 20px; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-on { background: var(--panel); border: 2px solid #555; } 
        .btn-off { background: var(--red); border: 2px solid var(--red); }
        .btn-active { background: white; color: black; }

        /* –ß–∞—Ç –ø–æ–≤–µ—Ä—Ö –≤–∏–¥–µ–æ (–º–æ–±–∏–ª—å–Ω—ã–π —Å—Ç–∏–ª—å) */
        #chat-overlay { position: absolute; bottom: 90px; left: 20px; width: 300px; max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; pointer-events: none; }
        .msg { background: rgba(0,0,0,0.6); padding: 8px 12px; border-radius: 15px; font-size: 13px; color: white; align-self: flex-start; pointer-events: auto; backdrop-filter: blur(4px); }
        
        /* –ò–Ω–ø—É—Ç —Å–æ–æ–±—â–µ–Ω–∏—è */
        .chat-input { position: absolute; bottom: 90px; right: 20px; display: flex; gap: 5px; }
        .chat-input input { margin: 0; width: 200px; background: rgba(0,0,0,0.7); border: 1px solid #555; }

        @media (max-width: 600px) {
            .vid-wrap { width: 100%; height: auto; }
            #chat-overlay { width: 80%; left: 10px; bottom: 140px; }
            .chat-input { bottom: 140px; right: 10px; width: auto; }
            .controls { padding-bottom: 30px; }
        }
    </style>
</head>
<body>

    <div id="login">
        <div class="card">
            <h2>üåê Global Connect</h2>
            <input type="text" id="nick" placeholder="–¢–≤–æ–π –Ω–∏–∫–Ω–µ–π–º">
            <select id="mics"></select>
            <button onclick="start()">–í–û–ô–¢–ò</button>
            <div id="status" style="margin-top:10px; font-size:12px; color:#888;"></div>
        </div>
    </div>

    <div id="app">
        <div id="video-grid"></div>
        
        <div id="chat-overlay"></div>
        
        <div class="chat-input" id="inputZone" style="display:none;">
            <input type="text" id="msgText" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMsg()">
            <button style="width:50px; padding:0;" onclick="sendMsg()">‚û§</button>
        </div>

        <div class="controls">
            <button class="btn-circle btn-on" id="micBtn" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
            <button class="btn-circle btn-off" id="camBtn" onclick="toggleCam()"><i class="fas fa-video-slash"></i></button>
            <button class="btn-circle btn-on" style="background:var(--primary); border:none;" onclick="copyLink()"><i class="fas fa-user-plus"></i></button>
            <button class="btn-circle btn-off" style="background:#333; border:none;" onclick="toggleChatInput()"><i class="fas fa-comment"></i></button>
        </div>
    </div>

    <script>
        let peer;
        let myStream;
        let myNick;
        const peers = {};
        
        // –°—Ç–∞—Ç—É—Å –∫–∞–º–µ—Ä—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ (false = –≤—ã–∫–ª)
        let camEnabled = false; 
        let micEnabled = true;

        // --- 1. –ù–ê–°–¢–†–û–ô–ö–ê –£–°–¢–†–û–ô–°–¢–í ---
        async function initDevices() {
            try {
                await navigator.mediaDevices.getUserMedia({audio:true});
                const devs = await navigator.mediaDevices.enumerateDevices();
                const sel = document.getElementById('mics');
                devs.filter(d=>d.kind==='audioinput').forEach(d=>{
                    sel.innerHTML += `<option value="${d.deviceId}">${d.label || 'Mic'}</option>`;
                });
            } catch(e) { console.log(e); }
        }
        initDevices();

        // --- 2. –°–¢–ê–†–¢ (–° –£–õ–£–ß–®–ï–ù–ù–´–ú STUN) ---
        async function start() {
            myNick = document.getElementById('nick').value || 'User';
            const micId = document.getElementById('mics').value;
            
            document.getElementById('status').innerText = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–∞–º–µ—Ä–µ...";

            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≤–∏–¥–µ–æ –∏ –∑–≤—É–∫, –Ω–æ...
                myStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 },
                    audio: { deviceId: micId ? {exact:micId} : undefined, echoCancellation:true, noiseSuppression:true }
                });

                // ...–°–†–ê–ó–£ –í–´–ö–õ–Æ–ß–ê–ï–ú –í–ò–î–ï–û (–ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ)
                myStream.getVideoTracks()[0].enabled = false; 
                camEnabled = false;

                document.getElementById('login').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                
                addVideo(myStream, true, myNick); // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è
                initPeer();

            } catch(e) {
                alert("–û—à–∏–±–∫–∞: " + e.message + "\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–∫—Ä—ã—Ç—å Discord –∏–ª–∏ –¥—Ä—É–≥–∏–µ –≤–∫–ª–∞–¥–∫–∏.");
                document.getElementById('status').innerText = "–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞.";
            }
        }

        // --- 3. PEERJS (–° –ì–õ–û–ë–ê–õ–¨–ù–´–ú–ò –°–ï–†–í–ï–†–ê–ú–ò) ---
        function initPeer() {
            peer = new Peer(null, {
                debug: 2,
                config: {
                    // –≠–¢–û –°–ê–ú–û–ï –í–ê–ñ–ù–û–ï –î–õ–Ø –°–í–Ø–ó–ò –ú–ï–ñ–î–£ –°–¢–†–ê–ù–ê–ú–ò
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:global.stun.twilio.com:3478' }
                    ]
                }
            });

            peer.on('open', id => {
                console.log('My ID:', id);
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ-–≤—Ö–æ–¥–∞ –ø–æ —Å—Å—ã–ª–∫–µ
                const urlParams = new URLSearchParams(window.location.search);
                const target = urlParams.get('call');
                if(target && target !== id) connectTo(target);
            });

            peer.on('call', call => {
                call.answer(myStream);
                handleCall(call);
            });
            
            peer.on('connection', conn => handleConn(conn));
        }

        function connectTo(id) {
            const call = peer.call(id, myStream);
            const conn = peer.connect(id);
            handleCall(call);
            handleConn(conn);
        }

        function handleCall(call) {
            if(peers[call.peer]) return;
            peers[call.peer] = call;

            call.on('stream', remoteStream => {
                // –ï—Å–ª–∏ –≤–∏–¥–µ–æ –µ—â–µ –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ–º
                if(!document.getElementById(`vid-${call.peer}`)) {
                    addVideo(remoteStream, false, "–°–æ–±–µ—Å–µ–¥–Ω–∏–∫", call.peer);
                }
            });
            call.on('close', () => removeVideo(call.peer));
        }

        let activeConn;
        function handleConn(conn) {
            activeConn = conn;
            conn.on('open', () => showMsg("–°–∏—Å—Ç–µ–º–∞", "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!"));
            conn.on('data', data => {
                if(data.type === 'chat') showMsg(data.nick, data.text);
            });
        }

        // --- 4. –ò–ù–¢–ï–†–§–ï–ô–° ---
        function addVideo(stream, isMine, name, id="local") {
            const div = document.createElement('div');
            div.className = 'vid-wrap';
            div.id = `vid-${id}`;
            div.innerHTML = `
                <div class="vid-placeholder"><i class="fas fa-user"></i></div>
                <video autoplay playsinline ${isMine ? 'muted' : ''} style="${isMine ? 'transform:scaleX(-1)' : ''}"></video>
                <div class="name">${name}</div>
            `;
            const vid = div.querySelector('video');
            vid.srcObject = stream;
            
            // –°–ª–µ–¥–∏–º –∑–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –≤–∏–¥–µ–æ (–≤–∫–ª—é—á–µ–Ω–æ/–≤—ã–∫–ª—é—á–µ–Ω–æ)
            setInterval(() => {
                const track = stream.getVideoTracks()[0];
                if(track && track.enabled && !track.muted) {
                    vid.classList.remove('hidden');
                } else {
                    vid.classList.add('hidden');
                }
            }, 500);

            document.getElementById('video-grid').appendChild(div);
        }

        function removeVideo(id) {
            const el = document.getElementById(`vid-${id}`);
            if(el) el.remove();
        }

        // --- 5. –ö–ù–û–ü–ö–ò ---
        function toggleMic() {
            micEnabled = !micEnabled;
            myStream.getAudioTracks()[0].enabled = micEnabled;
            const btn = document.getElementById('micBtn');
            btn.className = micEnabled ? 'btn-circle btn-on' : 'btn-circle btn-off';
            btn.innerHTML = micEnabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
        }

        function toggleCam() {
            camEnabled = !camEnabled;
            myStream.getVideoTracks()[0].enabled = camEnabled;
            const btn = document.getElementById('camBtn');
            btn.className = camEnabled ? 'btn-circle btn-on' : 'btn-circle btn-off';
            btn.innerHTML = camEnabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
        }

        function copyLink() {
            const link = `${window.location.origin}${window.location.pathname}?call=${peer.id}`;
            navigator.clipboard.writeText(link);
            alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! –°–∫–∏–Ω—å –¥—Ä—É–≥—É.");
        }

        // –ß–∞—Ç
        function toggleChatInput() {
            const z = document.getElementById('inputZone');
            z.style.display = z.style.display === 'flex' ? 'none' : 'flex';
        }

        function sendMsg() {
            const txt = document.getElementById('msgText').value;
            if(!txt) return;
            if(activeConn) activeConn.send({type:'chat', nick:myNick, text:txt});
            showMsg("–Ø", txt);
            document.getElementById('msgText').value = '';
        }

        function showMsg(nick, text) {
            const div = document.createElement('div');
            div.className = 'msg';
            div.innerHTML = `<b>${nick}:</b> ${text}`;
            const over = document.getElementById('chat-overlay');
            over.appendChild(div);
            over.scrollTop = over.scrollHeight;
            setTimeout(() => div.remove(), 10000); // –£–¥–∞–ª—è—Ç—å —á–µ—Ä–µ–∑ 10 —Å–µ–∫
        }
    </script>
</body>
</html>
